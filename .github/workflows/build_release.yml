name: Build and Release Multi-Platform

on:
  push:
    tags:
      - 'v*'

jobs:
  # ==================================================================================
  # 1. WINDOWS BUILD (x64)
  # ==================================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: uv sync --frozen

      # Build Main App (Windows)
      - name: Build Main App (ABVME) üèóÔ∏è
        shell: cmd
        run: |
          uv run python -m nuitka ^
            --standalone ^
            --enable-plugin=pyside6 ^
            --windows-console-mode=disable ^
            --windows-icon-from-ico=assets/icon.ico ^
            --include-package=UnityPy.resources ^
            --include-package-data=UnityPy ^
            --include-package-data=archspec ^
            --include-data-dir=assets=assets ^
            --include-data-file=styles.qss=styles.qss ^
            --output-dir=dist_main ^
            --output-filename=ABVME.exe ^
            --assume-yes-for-downloads ^
            app.py

      - name: Zip Artifact üì¶
        run: powershell Compress-Archive -Path "dist_main\app.dist\*" -DestinationPath "ABVME-Windows-x64.zip"

      - name: Upload Asset üì§
        uses: softprops/action-gh-release@v2
        with:
          files: ABVME-Windows-x64.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # 2. LINUX BUILD (x64 & arm64)
  # ==================================================================================
  build-linux:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            zip_name: ABVME-Linux-x64.zip
          - arch: aarch64
            runner: ubuntu-24.04-arm
            zip_name: ABVME-Linux-arm64.zip

    runs-on: ${{ matrix.runner }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install System Deps (Linux) üêß
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf libfuse2

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: uv sync --frozen

      # Build Main App (Linux)
      - name: Build Main App (ABVME) üèóÔ∏è
        run: |
          uv run python -m nuitka \
            --standalone \
            --enable-plugin=pyside6 \
            --include-package=UnityPy.resources \
            --include-package-data=UnityPy \
            --include-package-data=archspec \
            --include-data-dir=assets=assets \
            --include-data-file=styles.qss=styles.qss \
            --output-dir=dist_main \
            --output-filename=ABVME \
            --assume-yes-for-downloads \
            app.py

      - name: Organize Files üìÇ
        run: |
          # add execute permission
          chmod +x dist_main/app.dist/ABVME

      - name: Zip Artifact üì¶
        run: |
          cd dist_main/app.dist
          zip -r ../${{ matrix.zip_name }} .

      - name: Upload Asset üì§
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.zip_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
