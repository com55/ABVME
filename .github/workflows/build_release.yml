name: Build and Release Multi-Platform

on:
  # 1. AUTO RELEASE TRIGGER
  push:
    tags:
      - 'v*'
  # 2. MANUAL TRIGGER
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  # ==================================================================================
  # 1. WINDOWS BUILD (x64)
  # ==================================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: uv sync --frozen

      # Build Main App (Windows)
      - name: Build Main App (ABVME) ðŸ—ï¸
        shell: cmd
        run: |
          uv run python -m nuitka ^
            --standalone ^
            --enable-plugin=pyside6 ^
            --windows-console-mode=disable ^
            --windows-icon-from-ico=assets/icon.ico ^
            --include-package=UnityPy.resources ^
            --include-package-data=UnityPy ^
            --include-package-data=archspec ^
            --include-data-dir=assets=assets ^
            --include-data-file=styles.qss=styles.qss ^
            --output-dir=dist_main ^
            --output-filename=ABVME.exe ^
            --assume-yes-for-downloads ^
            app.py

      - name: Prepare Assets for Upload ðŸ“¦
        shell: powershell
        id: win_prepare_assets
        run: |
          $distPath = "dist_main\app.dist\*"
          # Release
          if ("${{ github.ref }}" -like 'refs/tags/v*') {
            Compress-Archive -Path $distPath -DestinationPath "ABVME-Windows-x64.zip"
            echo "WINDOWS_ARTIFACT_PATH=ABVME-Windows-x64.zip" >> $env:GITHUB_OUTPUT
          } 
          # Manual
          else {
            $timestamp = Get-Date -Format "ddMMyyyy-HHmm"
            $artifactName = "ABVME-Windows-x64-$timestamp"
            # 1. Rename directory inside dist_main
            Rename-Item -Path "dist_main\app.dist" -NewName $artifactName
            # 2. Use the correct relative path for upload (dist_main/new_name)
            $artifactPath = "dist_main\$artifactName"
            echo "WINDOWS_ARTIFACT_NAME=$artifactName" >> $env:GITHUB_OUTPUT
            echo "WINDOWS_ARTIFACT_PATH=$artifactPath" >> $env:GITHUB_OUTPUT
          }

      - name: Upload Artifact (Testing) ðŸ’¾
        uses: actions/upload-artifact@v4
        if: ${{ github.event_name == 'workflow_dispatch' }}
        with:
          name: ${{ steps.win_prepare_assets.outputs.WINDOWS_ARTIFACT_NAME }}
          path: ${{ steps.win_prepare_assets.outputs.WINDOWS_ARTIFACT_PATH }}

      - name: Upload Release Asset (Windows) ðŸ“¤
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ABVME-Windows-x64.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # 2. LINUX BUILD (x64 & arm64)
  # ==================================================================================
  build-linux:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            zip_name: ABVME-Linux-x64.zip
          - arch: aarch64
            runner: ubuntu-24.04-arm
            zip_name: ABVME-Linux-arm64.zip

    runs-on: ${{ matrix.runner }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install System Deps (Linux) ðŸ§
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf libfuse2

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: uv sync --frozen

      # Build Main App (Linux)
      - name: Build Main App (ABVME) ðŸ—ï¸
        run: |
          uv run python -m nuitka \
            --standalone \
            --enable-plugin=pyside6 \
            --include-package=UnityPy.resources \
            --include-package-data=UnityPy \
            --include-package-data=archspec \
            --include-data-dir=assets=assets \
            --include-data-file=styles.qss=styles.qss \
            --output-dir=dist_main \
            --output-filename=ABVME \
            --assume-yes-for-downloads \
            app.py

      - name: Prepare Assets for Upload ðŸ“¦
        id: linux_prepare_assets
        run: |
          chmod +x dist_main/app.dist/ABVME
          
          # Release
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            cd dist_main/app.dist
            zip -r ../../${{ matrix.zip_name }} .
          # Manual
          else
            timestamp=$(date +%d%m%Y-%H%M)
            artifactName="ABVME-Linux-${{ matrix.arch }}-$timestamp"
            artifactPath="dist_main/$artifactName"
            mv dist_main/app.dist $artifactPath
            echo "LINUX_ARTIFACT_NAME=$artifactName" >> $GITHUB_OUTPUT
            echo "LINUX_ARTIFACT_PATH=$artifactPath" >> $GITHUB_OUTPUT
          fi

      - name: Upload Artifact (Testing) ðŸ’¾
        uses: actions/upload-artifact@v4
        if: ${{ github.event_name == 'workflow_dispatch' }}
        with:
          name: ${{ steps.linux_prepare_assets.outputs.LINUX_ARTIFACT_NAME }}
          path: ${{ steps.linux_prepare_assets.outputs.LINUX_ARTIFACT_PATH }}

      - name: Upload Release Asset (Linux) ðŸ“¤
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.zip_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
