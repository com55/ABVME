name: Build and Release Multi-Platform

on:
  # 1. AUTO RELEASE TRIGGER
  push:
    tags:
      - 'v*'
  # 2. MANUAL TRIGGER
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  # ==================================================================================
  # 1. WINDOWS BUILD (x64)
  # ==================================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Dependencies
        run: uv export --no-hashes -o requirements.txt && pip install -r requirements.txt

      # Build Main App (Windows)
      - name: Build Main App (ABVME) ðŸ—ï¸
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: app.py
          mode: standalone
          enable-plugins: pyside6
          windows-console-mode: disable
          windows-icon-from-ico: assets/icon.ico
          include-package: UnityPy.resources
          include-package-data: |
            UnityPy
            archspec
          include-data-dir: assets=assets
          include-data-files: styles.qss=styles.qss
          output-dir: dist_main
          output-file: ABVME.exe

      - name: Prepare Assets for Upload ðŸ“¦
        shell: powershell
        id: win_prepare_assets
        run: |
          $distPath = "dist_main\*.dist\*"
          # Release
          if ("${{ github.ref }}" -like 'refs/tags/v*') {
            Compress-Archive -Path $distPath -DestinationPath "ABVME-Windows-x64.zip"
            echo "WINDOWS_ARTIFACT_PATH=ABVME-Windows-x64.zip" >> $env:GITHUB_OUTPUT
          } 
          # Manual
          else {
            $artifactName = "ABVME-Windows-x64"
            $distDir = Get-ChildItem -Path "dist_main" -Filter "*.dist" | Select-Object -First 1
            Rename-Item -Path $distDir.FullName -NewName $artifactName
            $artifactPath = "dist_main\$artifactName"
            echo "WINDOWS_ARTIFACT_NAME=$artifactName" >> $env:GITHUB_OUTPUT
            echo "WINDOWS_ARTIFACT_PATH=$artifactPath" >> $env:GITHUB_OUTPUT
          }

      - name: Upload Artifact (Testing) ðŸ’¾
        uses: actions/upload-artifact@v4
        if: ${{ github.event_name == 'workflow_dispatch' }}
        with:
          name: ${{ steps.win_prepare_assets.outputs.WINDOWS_ARTIFACT_NAME }}
          path: ${{ steps.win_prepare_assets.outputs.WINDOWS_ARTIFACT_PATH }}

      - name: Upload Release Asset (Windows) ðŸ“¤
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ABVME-Windows-x64.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # 2. LINUX BUILD (x64 & arm64)
  # ==================================================================================
  build-linux:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            zip_name: ABVME-Linux-x64.zip
          - arch: aarch64
            runner: ubuntu-24.04-arm
            zip_name: ABVME-Linux-arm64.zip

    runs-on: ${{ matrix.runner }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install System Deps (Linux) ðŸ§
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf libfuse2

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Dependencies
        run: uv export --no-hashes -o requirements.txt && pip install -r requirements.txt

      # Build Main App (Linux)
      - name: Build Main App (ABVME) ðŸ—ï¸
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: app.py
          mode: standalone
          enable-plugins: pyside6
          include-package: UnityPy.resources
          include-package-data: |
            UnityPy
            archspec
          include-data-dir: assets=assets
          include-data-files: styles.qss=styles.qss
          output-dir: dist_main
          output-file: ABVME

      - name: Prepare Assets for Upload ðŸ“¦
        id: linux_prepare_assets
        run: |
          distDir=$(find dist_main -maxdepth 1 -name "*.dist" -type d | head -1)
          chmod +x "$distDir/ABVME"
          
          # Release
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            cd "$distDir"
            zip -r ../../${{ matrix.zip_name }} .
          # Manual
          else
            artifactName="ABVME-Linux-${{ matrix.arch }}"
            artifactPath="dist_main/$artifactName"
            mv "$distDir" "$artifactPath"
            echo "LINUX_ARTIFACT_NAME=$artifactName" >> $GITHUB_OUTPUT
            echo "LINUX_ARTIFACT_PATH=$artifactPath" >> $GITHUB_OUTPUT
          fi

      - name: Upload Artifact (Testing) ðŸ’¾
        uses: actions/upload-artifact@v4
        if: ${{ github.event_name == 'workflow_dispatch' }}
        with:
          name: ${{ steps.linux_prepare_assets.outputs.LINUX_ARTIFACT_NAME }}
          path: ${{ steps.linux_prepare_assets.outputs.LINUX_ARTIFACT_PATH }}

      - name: Upload Release Asset (Linux) ðŸ“¤
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.zip_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
