name: Build and Release Multi-Platform

on:
  push:
    tags:
      - 'v*'

jobs:
  # ==================================================================================
  # 1. WINDOWS BUILD (x64)
  # ==================================================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: uv sync --frozen

      # 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Launcher Script (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ABVME.exe ‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô)
      - name: Create Launcher Script üìù
        shell: python
        run: |
          code = """
          import subprocess, sys, os
          from pathlib import Path
          
          # Path ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á: ./AssetBundlesEditorData/ABVME.exe
          base_dir = Path(__file__).absolute().parent
          target_exe = base_dir / "AssetBundlesEditorData" / "ABVME.exe"
          
          if not target_exe.exists():
              # Fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
              print(f"Error: Cannot find application at {target_exe}")
              input("Press Enter to exit...")
              sys.exit(1)
              
          cmd = [str(target_exe)] + sys.argv[1:]
          sys.exit(subprocess.call(cmd))
          """
          with open("launcher.py", "w", encoding="utf-8") as f:
              f.write(code)

      # 2. Build ‡∏ï‡∏±‡∏ß Main (ABVME) - ‡πÑ‡∏°‡πà‡∏°‡∏µ Icon ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô
      - name: Build Main App (ABVME) üèóÔ∏è
        shell: cmd
        run: |
          uv run python -m nuitka ^
            --standalone ^
            --enable-plugin=pyside6 ^
            --windows-console-mode=disable ^
            --include-package=UnityPy.resources ^
            --include-package-data=UnityPy ^
            --include-package-data=archspec ^
            --include-data-dir=assets=assets ^
            --include-data-file=styles.qss=styles.qss ^
            --output-dir=dist_main ^
            --output-filename=ABVME.exe ^
            --assume-yes-for-downloads ^
            app.py

      # 3. Build Launcher - ‡πÉ‡∏™‡πà Icon ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà! (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå assets/icon.ico ‡πÉ‡∏ô repo)
      - name: Build Launcher üöÄ
        shell: cmd
        run: |
          uv run python -m nuitka ^
            --onefile ^
            --windows-console-mode=disable ^
            --windows-icon-from-ico=assets/icon.ico ^
            --output-dir=dist_launcher ^
            --output-filename=AssetBundlesEditor.exe ^
            --assume-yes-for-downloads ^
            launcher.py

      # 4. ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÑ‡∏ü‡∏•‡πå
      - name: Organize Files üìÇ
        shell: pwsh
        run: |
          mkdir FinalBuild
          # ‡∏¢‡πâ‡∏≤‡∏¢ Main ‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Data
          Move-Item -Path "dist_main\app.dist" -Destination "FinalBuild\AssetBundlesEditorData"
          
          # ‡∏¢‡πâ‡∏≤‡∏¢ Launcher ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î
          Move-Item -Path "dist_launcher\AssetBundlesEditor.exe" -Destination "FinalBuild\AssetBundlesEditor.exe"

      - name: Zip Artifact ü§ê
        run: powershell Compress-Archive -Path "FinalBuild\*" -DestinationPath "AssetBundlesEditor-Windows-x64.zip"

      - name: Upload Asset üì§
        uses: softprops/action-gh-release@v2
        with:
          files: AssetBundlesEditor-Windows-x64.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================================
  # 2. LINUX BUILD (x64 & arm64)
  # ==================================================================================
  build-linux:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            zip_name: AssetBundlesEditor-Linux-x64.zip
          - arch: aarch64
            runner: ubuntu-24.04-arm # ‡πÉ‡∏ä‡πâ ARM Runner (‡∏ü‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public Repo)
            zip_name: AssetBundlesEditor-Linux-arm64.zip

    runs-on: ${{ matrix.runner }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install System Deps (Linux) üêß
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf libfuse2

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: uv sync --frozen

      # 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Launcher Script (Linux Version)
      - name: Create Launcher Script (Linux) üìù
        shell: python
        run: |
          code = """
          import subprocess, sys, os
          from pathlib import Path
          
          # Linux: ‡πÑ‡∏°‡πà‡∏°‡∏µ .exe ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ .bin ‡πÅ‡∏•‡πâ‡∏ß
          base_dir = Path(__file__).absolute().parent
          target = base_dir / "AssetBundlesEditorData" / "ABVME"
          
          if not target.exists():
              print(f"Error: Cannot find application at {target}")
              sys.exit(1)
              
          cmd = [str(target)] + sys.argv[1:]
          sys.exit(subprocess.call(cmd))
          """
          with open("launcher.py", "w", encoding="utf-8") as f:
              f.write(code)

      # 2. Build Main App (Linux) - ‡πÄ‡∏≠‡∏≤ .bin ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå output
      - name: Build Main App (ABVME) üèóÔ∏è
        run: |
          uv run python -m nuitka \
            --standalone \
            --enable-plugin=pyside6 \
            --include-package=UnityPy.resources \
            --include-package-data=UnityPy \
            --include-package-data=archspec \
            --include-data-dir=assets=assets \
            --include-data-file=styles.qss=styles.qss \
            --output-dir=dist_main \
            --output-filename=ABVME \
            --assume-yes-for-downloads \
            app.py

      # 3. Build Launcher (Linux)
      - name: Build Launcher üöÄ
        run: |
          uv run python -m nuitka \
            --onefile \
            --output-dir=dist_launcher \
            --output-filename=AssetBundlesEditor \
            --assume-yes-for-downloads \
            launcher.py

      # 4. ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÑ‡∏ü‡∏•‡πå
      - name: Organize Files üìÇ
        run: |
          mkdir FinalBuild
          # ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå output ‡∏Ç‡∏≠‡∏á Nuitka ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô {filename}.dist
          mv dist_main/app.dist FinalBuild/AssetBundlesEditorData
          mv dist_launcher/AssetBundlesEditor FinalBuild/AssetBundlesEditor
          
          # ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå execute
          chmod +x FinalBuild/AssetBundlesEditor
          chmod +x FinalBuild/AssetBundlesEditorData/ABVME

      - name: Zip Artifact ü§ê
        run: |
          cd FinalBuild
          zip -r ../${{ matrix.zip_name }} .

      - name: Upload Asset üì§
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.zip_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
